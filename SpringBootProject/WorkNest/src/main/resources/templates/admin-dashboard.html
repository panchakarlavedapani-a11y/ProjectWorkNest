<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* Layout */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f4f6f9;
      color: #333;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #1e3c72, #2a5298);
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.15);
    }
    .sidebar h2 {
      font-size: 22px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 40px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.3);
    }
    .nav-link {
      cursor: pointer;
      font-weight: 500;
      padding: 12px;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.1);
      text-align: center;
      transition: all 0.3s ease;
    }
    .nav-link:hover { background-color: rgba(255,255,255,0.25); transform: translateY(-2px); }
    .logout { margin-top: auto; text-align: center; }
    .logout a { color: #f0f0f0; text-decoration: none; font-weight: bold; }
    .logout a:hover { text-decoration: underline; }

    /* Main content */
    .main {
      flex: 1;
      padding: 20px 20px 40px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-image: url('/images/img3.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    /* Counters */
    .cards {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-left: 100px;
    }
    .card {
      padding: 18px;
      border-radius: 10px;
      background: white;
      min-width: 130px;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .card:hover { transform: scale(1.05); background: #f8fbff; }

    /* Tables */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    td, th { border: 1px solid #eee; padding: 10px; vertical-align: top; }
    th { background-color: #f1f5fb; font-weight: bold; }
    form.inline { display: inline; }

    h3 { margin-top: 24px; text-align: center; color: #1e3c72; }

    /* Sections */
    .section { display: none; width: 100%; max-width: 1000px; }
    .section.active { display: block; margin-top: 50px; margin-left: 100px; margin-right: 100px; }

    /* Center Add Task/User cards */
    #addTask.section.active,
    #addUser.section.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 10px;
    }

    /* === Unified form card === */
    .form-card {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
      padding: 30px;
      width: 100%;
      max-width: 640px;
    }
    .form-card h2 {
      margin-bottom: 20px;
      color: #2a5298;
      text-align: center;
      font-weight: 700;
    }

    /* TRUE two-column alignment */
    .form-grid {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 14px 20px;            /* row gap / column gap */
      align-items: center;        /* vertically center inputs next to labels */
    }
    .form-grid label {
      font-weight: 600;
      color: #34495e;
    }
    .form-grid input[type="text"],
    .form-grid input[type="password"],
    .form-grid input[type="date"],
    .form-grid select,
    .form-grid textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      box-sizing: border-box;
    }
    .form-grid textarea { resize: vertical; }

    /* rows spanning full width (e.g., list container) */
    .full-row { grid-column: 1 / -1; }

    .assignees-scroller {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      background: #fafafa;
    }
    .assignee-item { display: flex; gap: 8px; align-items: center; }

    /* actions aligned under the input column */
    .actions { grid-column: 2 / 3; }
    .btn {
      margin-top: 10px;
      padding: 12px 20px;
      background-color: #2a5298;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .btn:hover { background-color: #1e3c72; }

    /* Messages */
    .success-message {
      background-color: #e6f7ff;
      color: #084298;
      border: 1px solid #b6e0fe;
      padding: 12px 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 15px;
      max-width: 1000px;
      width: 100%;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Dashboard</h2>

    <div class="nav-link" onclick="showSection('addTask')" id="link-addTask">
      <i class="fas fa-plus-circle"></i> Add Task
    </div>
    <div class="nav-link" onclick="showSection('addUser')" id="link-addUser">
      <i class="fas fa-user-plus"></i> Add User
    </div>
    <div class="nav-link" onclick="showSection('tasks')" id="link-tasks">
      <i class="fas fa-tasks"></i> Tasks
    </div>
    <div class="nav-link" onclick="showSection('manageUsers')" id="link-manageUsers">
      <i class="fas fa-users-cog"></i> Manage Users
    </div>

    <div class="logout">
      <a th:href="@{/logout}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">

    <!-- Global success toast -->
    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

    <!-- Add Task Section -->
    <div class="section active" id="addTask">
      <div class="form-card">
        <h2 class="task-heading">Add Task</h2>

        <form th:action="@{/admin/tasks}" method="post" class="form-grid">
          <div th:if="${_csrf != null}" class="full-row">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          </div>

          <label for="title">Title</label>
          <input id="title" type="text" name="title" placeholder="Title" required />

          <label for="description">Description</label>
          <input id="description" type="text" name="description" placeholder="Description" />

          <label>Assignees</label>
          <div class="assignees-scroller">
            <div th:each="u : ${users}">
              <label class="assignee-item">
                <input type="checkbox" name="assigneeIds" th:value="${u.id}" />
                <span th:text="${u.username}">User</span>
              </label>
            </div>
            <div th:if="${#lists.isEmpty(users)}" style="opacity:.7;">(No normal users available)</div>
          </div>

          <label for="startDate">Start Date</label>
          <input id="startDate" type="date" name="startDate" required />

          <label for="dueDate">Due Date</label>
          <input id="dueDate" type="date" name="dueDate" required />

          <div class="actions">
            <button type="submit" class="btn">Create</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add User Section -->
    <div class="section" id="addUser">
      <div class="form-card">
        <h2>Add User</h2>

        <form th:action="@{/admin/users}" method="post" class="form-grid">
          <div th:if="${_csrf != null}" class="full-row">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          </div>

          <label for="username">Username</label>
          <input id="username" type="text" name="username" placeholder="Enter username" required />

          <label for="password">Password</label>
          <input id="password" type="password" name="password" placeholder="Enter password" required />

          <label for="role">Role</label>
          <select id="role" name="role" required>
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>

          <div class="actions">
            <button type="submit" class="btn">Add User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section" id="tasks">
      <div class="cards">
        <div class="card">Pending: <b th:text="${countPending}">0</b></div>
        <div class="card">In Progress: <b th:text="${countInProgress}">0</b></div>
        <div class="card">Completed: <b th:text="${countCompleted}">0</b></div>
        <div class="card">Delayed: <b th:text="${countDelayed}">0</b></div>
      </div>

      <h3>Tasks</h3>
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Assignee</th>
            <th>Start</th>
            <th>Due</th>
            <th>Status</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="r : ${rows}">
            <td>
  <a th:href="@{|/admin/tasks/${r.task.id}|}" 
     th:text="${r.task.title}" 
     style="text-decoration:none; color:inherit; cursor:pointer;">
  </a>
</td>

            <td th:text="${r.assignee != null ? r.assignee.username : '(unassigned)'}">assignee</td>
            <td th:text="${r.task.startDate}">2025-01-01</td>
            <td th:text="${r.task.dueDate}">2025-01-02</td>
            <td th:text="${r.task.status}">PENDING</td>
            <td>
              <th:block th:with="list=${taskCommentsMap[r.task.id]}, totalCount=${list != null ? #lists.size(list) : 0}">
                <details class="comments">
                  <summary>
                    <b th:text="${totalCount}">0</b> <span> comment(s)</span>
                  </summary>
                  <table class="mini">
                    <tr th:each="c : ${list}">
                      <td style="white-space:nowrap;"><b th:text="${c.author.username}">user</b></td>
                      <td th:text="${c.content}">comment</td>
                      <td style="white-space:nowrap;">
                        <small th:text="${#temporals.format(c.createdAt, 'yyyy-MM-dd HH:mm')}">time</small>
                      </td>
                    </tr>
                    <tr th:if="${list == null || #lists.isEmpty(list)}">
                      <td colspan="3" style="opacity:.7">(no comments)</td>
                    </tr>
                  </table>
                </details>
              </th:block>
            </td>
            <td>
              <form class="inline" th:action="@{|/admin/tasks/${r.task.id}/status|}" method="post">
                <div th:if="${_csrf != null}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </div>
                <select name="status">
                  <option value="PENDING"     th:selected="${r.task.status.name()=='PENDING'}">PENDING</option>
                  <option value="IN_PROGRESS" th:selected="${r.task.status.name()=='IN_PROGRESS'}">IN PROGRESS</option>
                  <option value="COMPLETED"   th:selected="${r.task.status.name()=='COMPLETED'}">COMPLETED</option>
                  <option value="DELAYED"     th:selected="${r.task.status.name()=='DELAYED'}">DELAYED</option>
                </select>
                <button>Update</button>
              </form>
              <form class="inline" th:action="@{|/admin/tasks/${r.task.id}/delete|}" method="post">
                <div th:if="${_csrf != null}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </div>
                <button>Delete</button>
              </form>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(rows)}">
            <td colspan="7" style="text-align:center;">No tasks to show.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Manage Users Section -->
    <div class="section" id="manageUsers">
      <h3>Manage Users</h3>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Username</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="u, iStat : ${users}">
            <td th:text="${iStat.count}">1</td>
            <td th:text="${u.username}">user</td>
            <td th:text="${u.role}">USER</td>
            <td>
              <form class="inline" th:action="@{|/admin/users/${u.id}/delete|}" method="post">
                <div th:if="${_csrf != null}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </div>
                <button class="submit">Delete</button>
              </form>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(users)}">
            <td colspan="4" style="text-align:center; opacity:0.7;">No users to show.</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div> <!-- /main -->

  <script>
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
  </script>
</body>
</html>
